!function(e,t){"use strict";t.Firebase={},t.Firebase._getKey=function(e){return"function"==typeof e.key?e.key():e.name()},t.Firebase._determineAutoSync=function(t,i){var s=Object.getPrototypeOf(t);return e.extend({autoSync:s.hasOwnProperty("autoSync")?s.autoSync:!0},this,i).autoSync},t.Firebase.sync=function(e,i,s){var n=i.toJSON();"read"===e?t.Firebase._readOnce(i.firebase,function(e){var t=e.val();s.success&&s.success(t)},function(e){s.error&&s.error(e)}):"create"===e?t.Firebase._setWithCheck(i.firebase,n,s):"update"===e?t.Firebase._updateWithCheck(i.firebase,n,s):"delete"===e&&t.Firebase._setWithCheck(i.firebase,null,s)},t.Firebase._readOnce=function(e,t){e.once("value",t)},t.Firebase._setToFirebase=function(e,t,i){e.set(t,i)},t.Firebase._updateToFirebase=function(e,t,i){e.update(t,i)},t.Firebase._onCompleteCheck=function(e,t,i){i&&(e&&i.error?i.error(t,e,i):i.success&&i.success(t,null,i))},t.Firebase._setWithCheck=function(e,i,s){t.Firebase._setToFirebase(e,i,function(e){t.Firebase._onCompleteCheck(e,i,s)})},t.Firebase._updateWithCheck=function(e,i,s){t.Firebase._updateToFirebase(e,i,function(e){t.Firebase._onCompleteCheck(e,i,s)})},t.Firebase._throwError=function(e){throw new Error(e)},t.Firebase._determineRef=function(e){switch(typeof e){case"string":return new Firebase(e);case"object":return e;default:t.Firebase._throwError("Invalid type passed to url property")}},t.Firebase._checkId=function(e){var i=e.val();return t.Firebase._isPrimitive(i)&&t.Firebase._throwError("InvalidIdException: Models must have an Id. Note: You may be trying to sync a primitive value (int, string, bool)."),null===i&&(i={}),i.id=t.Firebase._getKey(e),i},t.Firebase._isPrimitive=function(t){return!e.isObject(t)&&null!==t},t.Firebase._promiseEvent=function(t){var i=t.syncPromise,s=t.success,n=t.error,r=t.context||this,o=t.complete,c=setInterval(e.bind(function(){i.resolve&&(i.success?s.call(r):i.err&&n.call(r,i.err),o&&o.call(r),clearInterval(c))},r))};var i=function(){function e(){this._initialSync={},this.firebase.on("value",function(e){this._setLocal(e),this._initialSync.resolve=!0,this._initialSync.success=!0,this.trigger("sync",this,null,null)},function(e){this._initialSync.resolve=!0,this._initialSync.err=e,this.trigger("error",this,e,null)},this),this._listenLocalChange(function(e){this.firebase.update(e)})}return e.protoype={fetch:function(e){t.Firebase._promiseEvent({syncPromise:this._initialSync,context:this,success:function(){this.trigger("sync",this,null,e)},error:function(t){this.trigger("err",this,t,e)},complete:function(){t.Firebase._onCompleteCheck(this._initialSync.err,this,e)}})}},e}(),s=function(){function e(){this._listenLocalChange(function(e){this.set(e,{silent:!0})})}return e}();t.Firebase.Model=t.Model.extend({constructor:function(n,r){t.Model.apply(this,arguments);var o=e.result(this,"defaults");switch(this.once("sync",function(){this.set(e.defaults(this.toJSON(),o))}),this.autoSync=t.Firebase._determineAutoSync(this,r),typeof this.url){case"string":this.firebase=t.Firebase._determineRef(this.url);break;case"function":this.firebase=t.Firebase._determineRef(this.url());break;case"object":this.firebase=t.Firebase._determineRef(this.url);break;default:t.Firebase._throwError("url parameter required")}this.autoSync?(e.extend(this,i.protoype),i.apply(this,arguments)):(s.apply(this,arguments),e.extend(this,s.protoype))},sync:function(e,i,s){t.Firebase.sync(e,i,s)},_setId:function(e){this.isNew()&&this.set("id",t.Firebase._getKey(e),{silent:!0})},_setLocal:function(e){var t=this._unsetAttributes(e);this.set(t)},_unsetAttributes:function(i){var s=t.Firebase._checkId(i);if("object"==typeof s&&null!==s){var n=e.difference(e.keys(this.attributes),e.keys(s));e.each(n,e.bind(function(e){this.unset(e)},this))}return this._setId(i),s},_updateModel:function(t){var i=t.changedAttributes();return e.each(t.changed,function(e,t){("undefined"==typeof e||null===e)&&("id"==t?delete i[t]:i[t]=null)}),i},_listenLocalChange:function(t){var i=t?"on":"off";this[i]("change",function(i){var s=this._updateModel(i);e.isFunction(t)&&t.call(this,s)},this)}});var n=function(){function i(){}return i.protoype={create:function(i,s){return i.id=t.Firebase._getKey(this.firebase.push()),s=e.extend({autoSync:!1},s),t.Collection.prototype.create.call(this,i,s)},add:function(i,s){return i.id=t.Firebase._getKey(this.firebase.push()),s=e.extend({autoSync:!1},s),t.Collection.prototype.add.call(this,i,s)},sync:function(e,i,s){t.Firebase.sync(e,i,s)},fetch:function(t){t=t?e.clone(t):{},void 0===t.parse&&(t.parse=!0);var i=t.success,s=this;return t.success=function(n){var r=[],o=e.keys(n);e.each(o,function(e){r.push(n[e])});var c=t.reset?"reset":"set";s[c](r,t),i&&i(s,r,t),t.autoSync=!1,t.url=this.url,s.trigger("sync",s,r,t)},this.sync("read",this,t)}},i}(),r=function(){function i(){this._initialSync={},this.firebase.on("child_added",e.bind(this._childAdded,this)),this.firebase.on("child_moved",e.bind(this._childMoved,this)),this.firebase.on("child_changed",e.bind(this._childChanged,this)),this.firebase.on("child_removed",e.bind(this._childRemoved,this)),e.defer(e.bind(function(){this.firebase.once("value",function(){this._initialSync.resolve=!0,this._initialSync.success=!0,this.trigger("sync",this,null,null)},function(e){this._initialSync.resolve=!0,this._initialSync.err=e,this.trigger("error",this,e,null)},this)},this)),this.listenTo(this,"change",this._updateModel,this),this.listenTo(this,"destroy",this._removeModel,this)}return i.protoype={add:function(t,i){var s=this._parseModels(t);i=i?e.clone(i):{},i.success=e.isFunction(i.success)?i.success:function(){};for(var n=0;n<s.length;n++){var r=s[n];i.silent===!0&&(this._suppressEvent=!0);var o=this.firebase.ref().child(r.id);o.set(r,e.bind(i.success,r))}return s},create:function(t,i){if(i=i?e.clone(i):{},i.wait&&this._log("Wait option provided to create, ignoring."),!t)return!1;var s=this.add([t],i);return s[0]},remove:function(i,s){var n=this._parseModels(i);s=s?e.clone(s):{},s.success=e.isFunction(s.success)?s.success:function(){};for(var r=0;r<n.length;r++){var o=n[r],c=this.firebase.child(o.id);s.silent===!0&&(this._suppressEvent=!0),t.Firebase._setWithCheck(c,null,s)}return n},reset:function(t,i){i=i?e.clone(i):{},this.remove(this.models,{silent:!0});var s=this.add(t,{silent:!0});return i.silent||this.trigger("reset",this,i),s},fetch:function(e){t.Firebase._promiseEvent({syncPromise:this._initialSync,context:this,success:function(){this.trigger("sync",this,null,e)},error:function(t){this.trigger("err",this,t,e)},complete:function(){t.Firebase._onCompleteCheck(this._initialSync.err,this,e)}})},_log:function(e){console&&console.log&&console.log(e)},_parseModels:function(i,s){var n=[],r=!e.isArray(i);i=r?i?[i]:[]:i.slice();for(var o=0;o<i.length;o++){var c=i[o];c.id||(c.id=t.Firebase._getKey(this.firebase.push())),c=t.Collection.prototype._prepareModel.call(this,c,s),c.toJSON&&"function"==typeof c.toJSON&&(c=c.toJSON()),n.push(c)}return n},_childAdded:function(e){var i=t.Firebase._checkId(e);this._suppressEvent===!0?(this._suppressEvent=!1,t.Collection.prototype.add.call(this,[i],{silent:!0})):t.Collection.prototype.add.call(this,[i]),this.get(i.id)._remoteAttributes=i},_childMoved:function(){},_childChanged:function(i){var s=t.Firebase._checkId(i),n=e.find(this.models,function(e){return e.id==s.id});if(!n)return void this._childAdded(i);this._preventSync(n,!0),n._remoteAttributes=s;var r=e.difference(e.keys(n.attributes),e.keys(s));e.each(r,function(e){n.unset(e)}),n.set(s),this.trigger("sync",this),this._preventSync(n,!1)},_childRemoved:function(e){var i=t.Firebase._checkId(e);this._suppressEvent===!0?(this._suppressEvent=!1,t.Collection.prototype.remove.call(this,[i],{silent:!0})):(this.trigger("sync",this),t.Collection.prototype.remove.call(this,[i]))},_updateModel:function(t){var i,s,n,r;t._remoteChanging||(i=t._remoteAttributes||{},s=t.toJSON(),n=this._compareAttributes(i,s),r=this.firebase.ref().child(t.id),e.has(n,".priority")?this._setWithPriority(r,s):this._updateToFirebase(r,s))},_compareAttributes:function(t,i){var s={},n=e.union(e.keys(t),e.keys(i));return e.each(n,function(n){e.has(i,n)?i[n]!=t[n]&&(s[n]=i[n]):s[n]=null}),s},_setWithPriority:function(e,t){var i=t[".priority"];return delete t[".priority"],e.setWithPriority(t,i),t},_updateToFirebase:function(e,t){e.update(t)},_removeModel:function(i,s,n){n=n?e.clone(n):{},n.success=e.isFunction(n.success)?n.success:function(){};var r=this.firebase.child(i.id);t.Firebase._setWithCheck(r,null,e.bind(n.success,i))},_preventSync:function(e,t){e._remoteChanging=t}},i}();t.Firebase.Collection=t.Collection.extend({constructor:function(i,s){t.Collection.apply(this,arguments);var o=this,c=o.model;switch(this.autoSync=t.Firebase._determineAutoSync(this,s),typeof this.url){case"string":this.firebase=t.Firebase._determineRef(this.url);break;case"function":this.firebase=t.Firebase._determineRef(this.url());break;case"object":this.firebase=t.Firebase._determineRef(this.url);break;default:throw new Error("url parameter required")}this.autoSync?(e.extend(this,r.protoype),r.apply(this,arguments)):(e.extend(this,n.protoype),n.apply(this,arguments)),this.model=function(e,i){var s=new c(e,i);return s.autoSync=!1,s.firebase=o.firebase.ref().child(s.id),s.sync=t.Firebase.sync,s.on("change",function(e){var i=t.Firebase.Model.prototype._updateModel(e);e.set(i,{silent:!0})}),s}},comparator:function(e){return e.id}})}(window._,window.Backbone);